---
apiVersion: opentelemetry.io/v1beta1
kind: OpenTelemetryCollector
metadata:
  name: otel
  namespace: {{ .Release.Namespace }}
  labels: 
    observability-demo-framework: 'otel'
  {{- if .Values.annotationsWave3 }}
  annotations: {{- toYaml .Values.annotationsWave3 | nindent 4 }}
  {{- end }}
spec:
  observability:
    metrics:
      enableMetrics: true
  config:
    connectors:
      spanmetrics:
        metrics_flush_interval: 15s
    exporters:      
      otlphttp/loki:
        endpoint: 'https://logging-distributor-http.openshift-logging.svc.cluster.local:3100/otlp'
        headers:
          x-scope-orgid: application
        retry_on_failure:
          enabled: true
          initial_interval: 60s
          max_elapsed_time: 86400s
          max_interval: 86400s
        tls:
          ca_file: /lokistack-ca/service-ca.crt
          cert_file: /lokistack-tls/tls.crt
          key_file: /lokistack-tls/tls.key
      otlp/tempo:
        auth:
          authenticator: bearertokenauth
        endpoint: '{{ printf "tempo-traces-gateway.%s.svc.cluster.local:8090" .Release.Namespace }}'
        headers:
          X-Scope-OrgID: obsdemo
        tls:
          ca_file: /var/run/secrets/kubernetes.io/serviceaccount/service-ca.crt
          insecure: false
      prometheus:
        add_metric_suffixes: false
        endpoint: '0.0.0.0:8889'
        resource_to_telemetry_conversion:
          enabled: true
    extensions:
      bearertokenauth:
        filename: /var/run/secrets/kubernetes.io/serviceaccount/token
    processors:
      batch:
        send_batch_max_size: 1024
        send_batch_size: 1024
      memory_limiter:
        check_interval: 1s
        limit_mib: 1000
        spike_limit_percentage: 10
    receivers:
      otlp:
        protocols:
          grpc:
            endpoint: '0.0.0.0:4317'
          http:
            endpoint: '0.0.0.0:4318'
    service:
      extensions:
        - bearertokenauth
      pipelines:
        logs:
          exporters:
            - otlphttp/loki
          processors:
            - memory_limiter
            - batch
          receivers:
            - otlp
        metrics:
          exporters:
            - prometheus
          receivers:
            - spanmetrics
        traces:
          exporters:
            - otlp/tempo
            - spanmetrics
          receivers:
            - otlp
  mode: deployment
  managementState: managed  
  serviceAccount: otel-collector
  volumeMounts:
    - mountPath: /lokistack-tls
      name: lokistack-tls
    - mountPath: /lokistack-ca
      name: lokistack-ca
  ingress:
    route: {}
  serviceAccount: otel-collector
  volumes:
    - name: lokistack-tls
      secret:
        items:
          - key: tls.crt
            path: tls.crt
          - key: tls.key
            path: tls.key
        secretName: logging-gateway-client-http
    - configMap:
        items:
          - key: service-ca.crt
            path: service-ca.crt
        name: logging-ca-bundle
      name: lokistack-ca
